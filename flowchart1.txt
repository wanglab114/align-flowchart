┌─────────────────────────────────────────────┐
│           程序启动 (align_flowchart.py)      │
└─────────────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │  解析命令行参数         │
        │  - 输入文件路径 (-i)    │
        │  - 输出文件路径 (-o)    │
        │  - 调试模式 (--debug)   │
        └────────────────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │  检查输入文件是否存在   │
        └────────────────────────┘
                     │
            ┌────────┴────────┐
            │                  │
         存在                不存在
            │                  │
            ▼                  ▼
    ┌──────────────┐   ┌──────────────┐
    │ 读取文件内容 │   │ 输出错误信息 │
    │ (UTF-8编码)  │   │ 退出程序     │
    └──────────────┘   └──────────────┘
            │
            ▼
    ┌──────────────────────────────┐
    │  按行分割文本内容             │
    │  lines = text_raw.splitlines()│
    └──────────────────────────────┘
            │
            ▼
    ┌──────────────────────────────┐
    │  Step 1: 查找含竖线的行      │
    │  - has_text_and_pipe()       │
    │  - find_all_pipes()           │
    │  - 记录竖线位置(字符索引+显示)│
    └──────────────────────────────┘
            │
            ▼
        ┌─────────┐
        │找到匹配行?│
        └─────────┘
            │
    ┌───────┴───────┐
    │               │
   否              是
    │               │
    ▼               ▼
┌─────────┐  ┌──────────────────────────┐
│输出原文  │  │  Step 2: 查找目标位置    │
│退出程序  │  │  - find_nearest_corner()│
└─────────┘  │  - 在上下2行、左右2列范围 │
             │  - 查找最近的┐或┌         │
             │  - find_targets_for_all() │
             └──────────────────────────┘
                        │
                        ▼
             ┌──────────────────────┐
             │  Step 3: 迭代对齐     │
             │  iteration = 0        │
             │  max_iterations = 10  │
             └──────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  迭代循环开始                   │
        │  while has_changes and         │
        │        iteration < max_iter    │
        └───────────────────────────────┘
                        │
            ┌───────────┴───────────┐
            │                       │
      iteration > 1            iteration == 1
            │                       │
            ▼                       │
    ┌──────────────┐               │
    │ 重新查找目标位置│               │
    │ (因为行已改变)  │               │
    └──────────────┘               │
            │                       │
            └───────────┬───────────┘
                        ▼
            ┌──────────────────────┐
            │  align_lines_one_round│
            │  执行一轮对齐处理      │
            └──────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  遍历所有行                    │
        │  for idx, line in lines:       │
        └───────────────────────────────┘
                        │
                        ▼
            ┌──────────────────────┐
            │  该行有目标竖线?      │
            └──────────────────────┘
                        │
            ┌───────────┴───────────┐
            │                       │
           否                      是
            │                       │
            ▼                       ▼
    ┌──────────────┐      ┌──────────────────┐
    │ 保留原行      │      │ 找到第一个错位竖线│
    │ aligned.append│      │ (最左边的)       │
    └──────────────┘      └──────────────────┘
                                    │
                                    ▼
                        ┌──────────────────────┐
                        │ 计算显示位置差值      │
                        │ display_diff =        │
                        │   target_col -        │
                        │   display_pos         │
                        └──────────────────────┘
                                    │
                        ┌───────────┴───────────┐
                        │                       │
                  display_diff > 0      display_diff < 0
                        │                       │
                        ▼                       ▼
            ┌──────────────────┐    ┌──────────────────┐
            │ 竖线偏左          │    │ 竖线偏右          │
            │ 在竖线前插入空格  │    │ 删除竖线前字符   │
            │ adjust_line_for_  │    │ (优先删除非空格) │
            │   pipe()          │    │ adjust_line_for_ │
            └──────────────────┘    │   pipe()         │
                                    └──────────────────┘
                                    │
                                    ▼
                        ┌──────────────────────┐
                        │ 更新对齐后的行        │
                        │ aligned.append()     │
                        └──────────────────────┘
                                    │
                        ┌───────────┴───────────┐
                        │                       │
                  所有行处理完毕                 │
                        │                       │
                        ▼                       │
            ┌──────────────────────┐            │
            │ 检查是否有变化        │            │
            │ has_changes?          │            │
            └──────────────────────┘            │
                        │                       │
            ┌───────────┴───────────┐           │
            │                       │           │
           是                      否           │
            │                       │           │
            ▼                       ▼           │
    ┌──────────────┐      ┌──────────────┐     │
    │ iteration++   │      │ 退出循环      │     │
    │ 继续下一轮     │      │ 所有竖线已对齐│     │
    └──────────────┘      └──────────────┘     │
            │                                   │
            └───────────────────────────────────┘
                        │
                        ▼
            ┌──────────────────────┐
            │ 达到最大迭代次数?      │
            └──────────────────────┘
                        │
            ┌───────────┴───────────┐
            │                       │
           是                      否
            │                       │
            ▼                       ▼
    ┌──────────────┐      ┌──────────────┐
    │ 输出警告信息  │      │ 正常完成      │
    └──────────────┘      └──────────────┘
                        │
                        ▼
            ┌──────────────────────┐
            │  Step 4: 输出结果     │
            │  result = "\n".join() │
            └──────────────────────┘
                        │
            ┌───────────┴───────────┐
            │                       │
        指定输出文件              未指定
            │                       │
            ▼                       ▼
    ┌──────────────┐      ┌──────────────┐
    │ 写入文件      │      │ 输出到控制台 │
    │ with open()   │      │ print()      │
    └──────────────┘      └──────────────┘
                        │
                        ▼
            ┌──────────────────────┐
            │      程序结束         │
            └──────────────────────┘