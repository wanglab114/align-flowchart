# 流程图竖线对齐工具 (align_flowchart.py)

## 功能说明

该脚本的背景是大模型工具对汉字的不友好。正常的西文字符占用一个字符位置，而汉字须占两个位置。考虑到此差别，大模型工具在输出流程图结果时也是尽力寻找平衡，但仍存在线框错位的情况，如：

```
┌──────────────────────────────────────────────┐
│                主程序入口 (main)             │
│  - 解析命令行参数 argparse                   │
│  - 根据 mode 调用不同子流程                  │
└──────────────────────────────────────────────┘
                     │
                     ▼
      ┌───────────────────────────┬────────────────────────────┬─────────────────────────────┐
      ▼                           ▼                            ▼
┌─────────────┐        ┌────────────────┐            ┌──────────────────────┐
│ extract 流程 │        │ train 流程     │            │ infer / realtime 流程 │
└─────────────┘        └────────────────┘            └──────────────────────┘
      │                           │                            │
      ▼                           ▼                            ▼
┌──────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│ 数据提取模块         │  │ 数据加载模块 (Dataset)  │  │ 推理流程模块             │
│ extract_sequences()  │  │ PoseSequenceDataset     │  │ infer_on_video()         │
└──────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
```

这个脚本用于自动对齐流程图中的竖线（│）字符和下角标字符（┘），使其与对应的┐或┌字符对齐。脚本会：

1. 识别包含文字和竖线的行
2. 识别包含下角标字符"┘"的行
3. 为每个竖线和"┘"找到最近的┐或┌位置（在top_line中，向上查找）
4. 通过插入或删除空格来对齐竖线
5. 当竖线偏右且没有足够空格时，调整目标角字符位置（插入"─"）
6. 同时调整配对的角字符（top_line的"┐"和bottom_line的"┘"）
7. 迭代处理直到所有竖线和角字符对齐

## 特性

- **智能查找目标位置**：在竖线的上方8行、左右5列范围内查找最近的┐或┌（仅在top_line中查找）
- **全角字符支持**：正确处理汉字、中文标点、全角字母数字符号等占2个字符位置的情况
- **迭代对齐**：逐轮处理，每次只调整每行第一个错位的字符，避免冲突
- **优先删除空格**：调整时优先删除竖线前的空格，保留行首的缩进
- **目标位置调整**：当竖线偏右且没有足够空格时，调整目标角字符位置来对齐
- **配对角字符对齐**：调整top_line的"┐"时，同时调整对应的bottom_line的"┘"，保持对齐
- **底部线框角标字符支持**：同时处理流程框的角标字符"┘"的对齐

## 使用方法

### 基本用法

```bash
# 从标准输入读取，输出到控制台
python align_flowchart.py < input.txt

# 使用管道
cat input.txt | python align_flowchart.py

# 指定输入和输出文件
python align_flowchart.py -i "input.txt" -o "output.txt"

# 使用 '-' 明确指定从标准输入读取
python align_flowchart.py -i - -o "output.txt"

# 显示详细的调试信息
python align_flowchart.py --debug < input.txt

# 完整示例
python align_flowchart.py --input "input.txt" --output "aligned.txt" --debug
```

### 命令行参数

- `--input`, `-i`: 输入文件路径（使用 `-` 或留空表示从标准输入读取）
- `--output`, `-o`: 输出文件路径（默认: 输出到标准输出）
- `--debug`: 显示详细的调试信息，包括：
  - 原始输入内容
  - 匹配到的含竖线的行
  - 每个竖线和下角标字符的目标位置
  - 每轮对齐的详细过程
  - 目标位置调整信息
  - 最终输出结果

### NotePad++ 宏调用

使用标准输入重定向（推荐）：

```
cmd /c C:\Users\wanglb\AppData\Local\Programs\Python\Python38-32\python  -X utf8  "C:\git\TOOL\align-flowchart\align_flowchart.py" < "$(FULL_CURRENT_PATH)" > "%TEMP%\aligned.txt" 
cmd /c copy /Y "%TEMP%\aligned.txt" "$(FULL_CURRENT_PATH)"
```

或者使用 `-i` 参数：

```
cmd /c C:\Users\wanglb\AppData\Local\Programs\Python\Python38-32\python  -X utf8  "C:\git\TOOL\align-flowchart\align_flowchart.py" -i "$(FULL_CURRENT_PATH)" -o "%TEMP%\aligned.txt"
cmd /c copy /Y "%TEMP%\aligned.txt" "$(FULL_CURRENT_PATH)"
```

## 工作原理

### 1. 识别含竖线和下角标字符的行

脚本会查找：
- 包含文字（非空白、非框线字符）和竖线字符（│）的行
- 包含下角标字符（┘）的行

### 2. 计算显示位置

由于全角字符在显示时占2个字符位置，脚本会计算每个字符的实际显示位置：

```
显示位置 = 字符索引 + 前面全角字符的数量
```

全角字符包括：
- 汉字（CJK统一汉字）
- 中文标点符号（，。！？；：""''（）【】《》等）
- 全角字母数字（ＡＢＣ、１２３等）
- 其他全角符号

例如：
- 字符串 `"测试│"` 中，`│` 的字符索引是 2，前面有2个汉字，显示位置是 2 + 2 = 4

### 3. 查找目标位置

对于每个竖线或下角标字符，脚本会在以下范围内查找最近的┐或┌：
- **查找方向**：仅在top_line中向上查找（不在下行查找）
- **上下行范围**：默认向上8行（可通过代码中的 `row_range` 参数调整）
- **左右列范围**：默认左右5列（可通过代码中的 `col_range` 参数调整）

查找时会计算每个┐或┌的显示位置，选择距离最近的作为对齐目标。

### 4. 对齐处理

对齐过程采用迭代方式：

1. **第一轮**：为所有竖线和下角标字符找到目标位置
2. **每轮处理**：
   - 重新计算所有字符的显示位置和目标位置
   - 对每行，找到第一个（最左边）错位的字符（竖线"│"或下角标字符"┘"）
   - 调整该字符到目标位置：
     - **如果字符偏左**：在字符前插入空格
     - **如果字符偏右**：优先删除字符前的空格
   - 如果字符偏右且没有足够的空格可删：
     - 在目标角字符（┐或┌）前插入"─"字符，将目标位置右移
     - 在对应的bottom_line中查找配对的角字符（┘或└）
     - 在配对的角字符前也插入相同数量的"─"字符，保持对齐
3. **继续迭代**：直到所有字符对齐或达到最大迭代次数（默认10次）

### 5. 调整策略

#### 竖线位置调整

- **插入空格**：如果竖线位置偏左，直接在竖线前插入所需数量的空格
- **删除空格**：如果竖线位置偏右：
  1. 优先删除竖线前的空格（从右向左）
  2. 如果空格不够，不调整该行，让下一轮迭代时重新查找目标位置

#### 目标位置调整

当竖线偏右且没有足够的空格可删时：
- 在目标角字符（┐或┌）所在行的角字符前插入"─"字符
- 在对应的bottom_line中查找配对的角字符（┘或└）
- 在配对的角字符前也插入相同数量的"─"字符
- 这样既对齐了竖线，又保持了流程框的top_line和bottom_line对齐

## 示例

### 输入示例

```
┌─────────┐
│ 测试│   │
│ 数据│   │
└─────────┘
```

### 输出示例

```
┌─────────┐
│ 测试  │ │
│ 数据  │ │
└─────────┘
```

## 注意事项

1. **文件编码**：脚本使用 UTF-8 编码读取文件，如果文件编码不同可能导致问题
2. **全角字符识别**：脚本通过 `unicodedata.east_asian_width()` 和 Unicode 范围识别全角字符
3. **迭代限制**：默认最大迭代10次，如果仍有未对齐的字符，会显示警告信息
4. **目标查找范围**：如果字符附近没有找到┐或┌，该字符不会被调整
5. **查找方向**：脚本在top_line中向上查找目标角字符

## 调试模式

使用 `--debug` 参数可以查看详细的处理过程：

```
====== RAW INPUT ======
（显示原始输入内容）

====== MATCHED LINES (text + │) ======
（显示所有匹配到的行和竖线位置）

====== INITIAL TARGET FINDING ======
（显示每个竖线和下角标字符的目标位置）

====== ALIGNMENT ROUND 1 ======
（显示每轮对齐的详细过程，包括目标位置调整）

====== FINAL OUTPUT ======
（显示最终输出结果）
```

## 代码结构

- `is_wide_char(char)`: 判断字符是否占两个字符位置（全角字符）
- `count_wide_chars(text)`: 计算文本中占两个位置的字符数量
- `has_text_and_pipe(line)`: 检查行是否含有文字和竖线
- `find_all_pipes(line)`: 找到行中所有竖线的位置（字符索引和显示位置）
- `find_all_bottom_corners(line)`: 找到行中所有下角标字符"┘"的位置
- `find_nearest_corner(...)`: 查找与竖线或下角标字符最近的角字符位置（仅在top_line中向上查找）
- `find_targets_for_all_lines(lines)`: 为所有含竖线和下角标字符的行找到目标位置
- `find_paired_corner_in_bottom_line(...)`: 在对应的bottom_line中查找配对的角字符
- `adjust_line_for_pipe(...)`: 调整一行中的单个竖线位置（通过插入或删除空格）
- `align_lines_one_round(...)`: 执行一轮对齐处理

## align-flowchart 工具流程图

### 简化版流程图

```
┌─────────────────────────────┐
│   程序启动                  │
│   align_flowchart.py        │
└─────────────────────────────┘
            │
            ▼
┌─────────────────────────────┐
│   读取输入                  │
│   (文件或标准输入)          │
└─────────────────────────────┘
            │
            ▼
┌─────────────────────────────┐
│   Step 1: 识别目标行        │
│   - 查找含文字和竖线的行    │
│   - 查找含"┘"的行           │
│   - 记录字符位置            │
└─────────────────────────────┘
            │
            ▼
        ┌───────────┐
        │找到匹配行?│
        └───────────┘
            │
    ┌───────┴───────┐
    │               │
   否              是
    │               │
    ▼               ▼
┌─────────┐  ┌──────────────────┐
│输出原文 │  │  Step 2: 查找目标│
│退出程序 │  │  - 在top_line中  │
└─────────┘  │   向上查找┐/┌    │
             │  - 计算距离      │
             └──────────────────┘
                    │
                    ▼
        ┌──────────────────────┐
        │  Step 3: 迭代对齐    │
        │  while has_changes   │
        └──────────────────────┘
                    │
                    ▼
        ┌──────────────────────┐
        │  每轮处理            │
        │  - 重新查找目标位置  │
        │  - 调整第一个错位字符│
        │  - 必要时调整目标位置│
        └──────────────────────┘
                    │
                    ▼
        ┌──────────────────────┐
        │  Step 4: 输出结果    │
        │  (文件或标准输出)    │
        └──────────────────────┘
                    │
                    ▼
        ┌──────────────────────┐
        │      程序结束        │
        └──────────────────────┘

## 版本信息

- 支持 Python 3.x
- 依赖标准库：`re`, `sys`, `os`, `argparse`, `unicodedata`

## 许可证

本脚本为工具脚本，可自由使用和修改。
