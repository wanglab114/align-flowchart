# 流程图竖线对齐工具 (align_flowchart.py)

## 功能说明

该脚本的背景是大模型工具对汉字的不友好。 正常的西文字符占用一个字符位置，而汉字须占两个位置。 考虑到此差别，大模型工具在输出流程图结果时也是尽力寻找平衡，但仍存在线框错位的情况，如：
┌──────────────────────────────────────────────┐
│                主程序入口 (main)             │
│  - 解析命令行参数 argparse                   │
│  - 根据 mode 调用不同子流程                  │
└──────────────────────────────────────────────┘
                     │
                     ▼
      ┌───────────────────────────┬────────────────────────────┬─────────────────────────────┐
      ▼                           ▼                            ▼
┌─────────────┐        ┌────────────────┐            ┌──────────────────────┐
│ extract 流程 │        │ train 流程     │            │ infer / realtime 流程 │
└─────────────┘        └────────────────┘            └──────────────────────┘
      │                           │                            │
      ▼                           ▼                            ▼
┌──────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│ 数据提取模块         │  │ 数据加载模块 (Dataset)  │  │ 推理流程模块             │
│ extract_sequences()  │  │ PoseSequenceDataset     │  │ infer_on_video()         │
└──────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
      │                           │                            │
      │(调用)                     │(调用)                      │(调用)
      ▼                           ▼                            ▼
┌──────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│ 姿态检测模块         │  │ 模型定义模块             │  │ 模型定义模块             │
│ MediapipeExtractor    │  │ LSTMActionModel         │  │ LSTMActionModel         │
└──────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
      │                           │                            │
      ▼                           ▼                            ▼
┌──────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│ 序列生成模块         │  │ 模型训练模块             │  │ 视频读取模块             │
│ sliding_window()     │  │ train_one_epoch()       │  │ OpenCV VideoCapture      │
└──────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
      │                           │                            │
      ▼                           ▼                            ▼
┌──────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│ NPZ 数据保存         │  │ 模型保存 (pth + classes)│  │ 输出预测类别与置信度     │
└──────────────────────┘  └─────────────────────────┘  └─────────────────────────┘

这个脚本用于自动对齐流程图中的竖线（│）字符，使其与对应的┐或┌字符对齐。脚本会：

1. 识别包含文字和竖线的行
2. 为每个竖线找到最近的┐或┌位置（在上下行、左右列范围内）
3. 通过插入或删除空格来对齐竖线
4. 迭代处理直到所有竖线对齐

## 特性

- **智能查找目标位置**：在竖线的上下2行、左右2列范围内查找最近的┐或┌
- **汉字支持**：正确处理汉字占2个字符位置的情况
- **迭代对齐**：逐轮处理，每次只调整每行第一个错位的竖线，避免冲突
- **保留缩进**：调整时优先删除非空格字符，保留行首的缩进空格

## 使用方法

### 基本用法

```bash
# 使用默认输入文件，输出到控制台
python align_flowchart.py

# 指定输入和输出文件
python align_flowchart.py -i "input.txt" -o "output.txt"

# 显示详细的调试信息
python align_flowchart.py --debug

# 完整示例
python align_flowchart.py --input "C:\Users\wanglb\Desktop\new 10.txt" --output "aligned.txt" --debug
```

### 命令行参数

- `--input`, `-i`: 输入文件路径（默认: `C:\Users\wanglb\Desktop\new 10.txt`）
- `--output`, `-o`: 输出文件路径（默认: 输出到标准输出）
- `--debug`: 显示详细的调试信息，包括：
  - 原始输入内容
  - 匹配到的含竖线的行
  - 每个竖线的目标位置
  - 每轮对齐的详细过程
  - 最终输出结果

### NotePad++ 宏调用

cmd /c C:\Users\wanglb\AppData\Local\Programs\Python\Python38-32\python  -X utf8  "C:\git\TOOL\align-flowchart\align_flowchart.py" < "$(FULL_CURRENT_PATH)" > "%TEMP%\aligned.txt" 
cmd /c copy /Y "%TEMP%\aligned.txt" "$(FULL_CURRENT_PATH)"

## 工作原理

### 1. 识别含竖线的行

脚本会查找同时包含以下内容的行：
- 文字（非空白、非框线字符）
- 竖线字符（│）

### 2. 计算显示位置

由于汉字在显示时占2个字符位置，脚本会计算每个竖线的实际显示位置：

```
显示位置 = 字符索引 + 前面汉字的数量
```

例如：
- 字符串 `"测试│"` 中，`│` 的字符索引是 2，前面有2个汉字，显示位置是 2 + 2 = 4

### 3. 查找目标位置

对于每个竖线，脚本会在以下范围内查找最近的┐或┌：
- **上下行范围**：默认上下2行（可通过代码中的 `row_range` 参数调整）
- **左右列范围**：默认左右2列（可通过代码中的 `col_range` 参数调整）

查找时会计算每个┐或┌的显示位置，选择距离最近的作为对齐目标。

### 4. 对齐处理

对齐过程采用迭代方式：

1. **第一轮**：为所有竖线找到目标位置
2. **每轮处理**：
   - 重新计算所有竖线的显示位置和目标位置
   - 对每行，找到第一个（最左边）错位的竖线
   - 调整该竖线到目标位置
   - 如果竖线偏左：在竖线前插入空格
   - 如果竖线偏右：删除竖线前的字符（优先删除非空格字符）
3. **继续迭代**：直到所有竖线对齐或达到最大迭代次数（默认10次）

### 5. 调整策略

- **插入空格**：如果竖线位置偏左，直接在竖线前插入所需数量的空格
- **删除字符**：如果竖线位置偏右：
  1. 优先删除非空格字符（从右向左）
  2. 如果非空格字符不够，再删除部分空格
  3. 尽量保留行首的缩进空格

## 示例

### 输入示例

```
┌─────────┐
│ 测试│   │
│ 数据│   │
└─────────┘
```

### 输出示例

```
┌─────────┐
│ 测试  │ │
│ 数据  │ │
└─────────┘
```

## 注意事项

1. **文件编码**：脚本使用 UTF-8 编码读取文件，如果文件编码不同可能导致问题
2. **汉字识别**：脚本通过 Unicode 范围 `\u4e00-\u9fff` 识别汉字
3. **迭代限制**：默认最大迭代10次，如果仍有未对齐的竖线，会显示警告信息
4. **目标查找范围**：如果竖线附近没有找到┐或┌，该竖线不会被调整

## 调试模式

使用 `--debug` 参数可以查看详细的处理过程：

```
====== RAW INPUT ======
（显示原始输入内容）

====== MATCHED LINES (text + │) ======
（显示所有匹配到的行和竖线位置）

====== INITIAL TARGET FINDING ======
（显示每个竖线的目标位置）

====== ALIGNMENT ROUND 1 ======
（显示每轮对齐的详细过程）

====== FINAL OUTPUT ======
（显示最终输出结果）
```

## 代码结构

- `has_text_and_pipe(line)`: 检查行是否含有文字和竖线
- `find_all_pipes(line)`: 找到行中所有竖线的位置（字符索引和显示位置）
- `find_nearest_corner(...)`: 查找与竖线最近的┐或┌位置
- `find_targets_for_all_lines(lines)`: 为所有含竖线的行找到目标位置
- `adjust_line_for_pipe(...)`: 调整一行中的单个竖线位置
- `align_lines_one_round(...)`: 执行一轮对齐处理

## 故障排除

1. **文件不存在错误**：检查输入文件路径是否正确
2. **编码错误**：确保文件是 UTF-8 编码
3. **对齐不完整**：查看调试信息，检查是否有竖线找不到目标位置
4. **迭代次数过多**：可能需要调整查找范围或检查流程图结构

## 版本信息

- 支持 Python 3.x
- 依赖标准库：`re`, `sys`, `os`, `argparse`

## 许可证

本脚本为工具脚本，可自由使用和修改。

